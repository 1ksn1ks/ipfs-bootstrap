(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Libp2PTcp = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Libp2PTcp=(()=>{var Vn=Object.create;var Ue=Object.defineProperty;var zn=Object.getOwnPropertyDescriptor;var $n=Object.getOwnPropertyNames;var kn=Object.getPrototypeOf,Fn=Object.prototype.hasOwnProperty;var V=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var U=(r,e)=>{for(var t in e)Ue(r,t,{get:e[t],enumerable:!0})},Ir=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of $n(e))!Fn.call(r,s)&&s!==t&&Ue(r,s,{get:()=>e[s],enumerable:!(n=zn(e,s))||n.enumerable});return r};var oe=(r,e,t)=>(t=r!=null?Vn(kn(r)):{},Ir(e||!r||!r.__esModule?Ue(t,"default",{value:r,enumerable:!0}):t,r)),Wn=r=>Ir(Ue({},"__esModule",{value:!0}),r);var Ho={};U(Ho,{tcp:()=>qo});var Mn=oe(V("net"),1);var Re=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};var B=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};var Me=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}};var Q=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},Ce=class extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}};var ie=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}},Ve=class extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}},ze=class extends Error{static name="AlreadyStartedError";constructor(e="Already started"){super(e),this.name="AlreadyStartedError"}};var $e=class extends Event{data;constructor(e,t){super("message",t),this.data=e}},ae=class extends Event{error;local;constructor(e,t,n){super("close",n),this.error=t,this.local=e}},ke=class extends ae{constructor(e,t){super(!0,e,t)}},Fe=class extends ae{constructor(e,t){super(!1,e,t)}};var Ar=Symbol.for("@libp2p/transport");var Lr;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Lr||(Lr={}));var Pr=V("node:events"),We=(r,...e)=>{try{(0,Pr.setMaxListeners)(r,...e)}catch{}};var ce=class extends EventTarget{#e=new Map;constructor(){super(),We(1/0,this)}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:o})=>o!==t),this.#e.set(e,s))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};var Or=Symbol.for("@libp2p/service-capabilities"),ei=Symbol.for("@libp2p/service-dependencies");function je(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var Et=V("node:buffer");function Y(r){return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}function W(r=0){return Y(Et.Buffer.alloc(r))}function ue(r=0){return Y(Et.Buffer.allocUnsafe(r))}var jn=Math.pow(2,7),qn=Math.pow(2,14),Hn=Math.pow(2,21),vt=Math.pow(2,28),Ct=Math.pow(2,35),Dt=Math.pow(2,42),St=Math.pow(2,49),C=128,P=127;function le(r){if(r<jn)return 1;if(r<qn)return 2;if(r<Hn)return 3;if(r<vt)return 4;if(r<Ct)return 5;if(r<Dt)return 6;if(r<St)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Tt(r,e,t=0){switch(le(r)){case 8:e[t++]=r&255|C,r/=128;case 7:e[t++]=r&255|C,r/=128;case 6:e[t++]=r&255|C,r/=128;case 5:e[t++]=r&255|C,r/=128;case 4:e[t++]=r&255|C,r>>>=7;case 3:e[t++]=r&255|C,r>>>=7;case 2:e[t++]=r&255|C,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function Qn(r,e){let t=r[e],n=0;if(n+=t&P,t<C||(t=r[e+1],n+=(t&P)<<7,t<C)||(t=r[e+2],n+=(t&P)<<14,t<C)||(t=r[e+3],n+=(t&P)<<21,t<C)||(t=r[e+4],n+=(t&P)*vt,t<C)||(t=r[e+5],n+=(t&P)*Ct,t<C)||(t=r[e+6],n+=(t&P)*Dt,t<C)||(t=r[e+7],n+=(t&P)*St,t<C))return n;throw new RangeError("Could not decode varint")}function Gn(r,e){let t=r.get(e),n=0;if(n+=t&P,t<C||(t=r.get(e+1),n+=(t&P)<<7,t<C)||(t=r.get(e+2),n+=(t&P)<<14,t<C)||(t=r.get(e+3),n+=(t&P)<<21,t<C)||(t=r.get(e+4),n+=(t&P)*vt,t<C)||(t=r.get(e+5),n+=(t&P)*Ct,t<C)||(t=r.get(e+6),n+=(t&P)*Dt,t<C)||(t=r.get(e+7),n+=(t&P)*St,t<C))return n;throw new RangeError("Could not decode varint")}function It(r,e=0){return r instanceof Uint8Array?Qn(r,e):Gn(r,e)}var _r=V("node:buffer");function G(r,e){return Y(_r.Buffer.concat(r,e))}var en=V("node:buffer");var _t={};U(_t,{base10:()=>rs});var Bi=new Uint8Array(0);function Br(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function z(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Nr(r){return new TextEncoder().encode(r)}function Ur(r){return new TextDecoder().decode(r)}function Jn(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var o=r.charAt(s),i=o.charCodeAt(0);if(t[i]!==255)throw new TypeError(o+" is ambiguous");t[i]=s}var a=r.length,u=r.charAt(0),f=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(b){if(b instanceof Uint8Array||(ArrayBuffer.isView(b)?b=new Uint8Array(b.buffer,b.byteOffset,b.byteLength):Array.isArray(b)&&(b=Uint8Array.from(b))),!(b instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(b.length===0)return"";for(var v=0,m=0,S=0,_=b.length;S!==_&&b[S]===0;)S++,v++;for(var L=(_-S)*d+1>>>0,N=new Uint8Array(L);S!==_;){for(var M=b[S],H=0,$=L-1;(M!==0||H<m)&&$!==-1;$--,H++)M+=256*N[$]>>>0,N[$]=M%a>>>0,M=M/a>>>0;if(M!==0)throw new Error("Non-zero carry");m=H,S++}for(var F=L-m;F!==L&&N[F]===0;)F++;for(var Ne=u.repeat(v);F<L;++F)Ne+=r.charAt(N[F]);return Ne}function x(b){if(typeof b!="string")throw new TypeError("Expected String");if(b.length===0)return new Uint8Array;var v=0;if(b[v]!==" "){for(var m=0,S=0;b[v]===u;)m++,v++;for(var _=(b.length-v)*f+1>>>0,L=new Uint8Array(_);b[v];){var N=t[b.charCodeAt(v)];if(N===255)return;for(var M=0,H=_-1;(N!==0||M<S)&&H!==-1;H--,M++)N+=a*L[H]>>>0,L[H]=N%256>>>0,N=N/256>>>0;if(N!==0)throw new Error("Non-zero carry");S=M,v++}if(b[v]!==" "){for(var $=_-S;$!==_&&L[$]===0;)$++;for(var F=new Uint8Array(m+(_-$)),Ne=m;$!==_;)F[Ne++]=L[$++];return F}}}function l(b){var v=x(b);if(v)return v;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:x,decode:l}}var Kn=Jn,Yn=Kn,Mr=Yn;var Lt=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},At=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;let s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Vr(this,e)}},Pt=class{decoders;constructor(e){this.decoders=e}or(e){return Vr(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Vr(r,e){return new Pt({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var Ot=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Lt(e,t,n),this.decoder=new At(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function he({name:r,prefix:e,encode:t,decode:n}){return new Ot(r,e,t,n)}function X({name:r,prefix:e,alphabet:t}){let{encode:n,decode:s}=Mr(t,r);return he({prefix:e,name:r,encode:n,decode:o=>z(s(o))})}function Zn(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;let o=new Uint8Array(s*t/8|0),i=0,a=0,u=0;for(let f=0;f<s;++f){let d=e[r[f]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|d,i+=t,i>=8&&(i-=8,o[u++]=255&a>>i)}if(i>=t||(255&a<<8-i)!==0)throw new SyntaxError("Unexpected end of data");return o}function es(r,e,t){let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let u=0;u<r.length;++u)for(a=a<<8|r[u],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i!==0&&(o+=e[s&a<<t-i]),n)for(;(o.length*t&7)!==0;)o+="=";return o}function ts(r){let e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function D({name:r,prefix:e,bitsPerChar:t,alphabet:n}){let s=ts(n);return he({prefix:e,name:r,encode(o){return es(o,n,t)},decode(o){return Zn(o,s,t,r)}})}var rs=X({prefix:"9",name:"base10",alphabet:"0123456789"});var Bt={};U(Bt,{base16:()=>ns,base16upper:()=>ss});var ns=D({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ss=D({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var Nt={};U(Nt,{base2:()=>os});var os=D({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Ut={};U(Ut,{base256emoji:()=>ls});var zr=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),is=zr.reduce((r,e,t)=>(r[t]=e,r),[]),as=zr.reduce((r,e,t)=>{let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function cs(r){return r.reduce((e,t)=>(e+=is[t],e),"")}function us(r){let e=[];for(let t of r){let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);let s=as[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}var ls=he({prefix:"\u{1F680}",name:"base256emoji",encode:cs,decode:us});var Rt={};U(Rt,{base32:()=>J,base32hex:()=>ps,base32hexpad:()=>bs,base32hexpadupper:()=>gs,base32hexupper:()=>ms,base32pad:()=>fs,base32padupper:()=>ds,base32upper:()=>hs,base32z:()=>ws});var J=D({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),hs=D({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),fs=D({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ds=D({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ps=D({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ms=D({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),bs=D({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),gs=D({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ws=D({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Mt={};U(Mt,{base36:()=>De,base36upper:()=>xs});var De=X({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),xs=X({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Vt={};U(Vt,{base58btc:()=>k,base58flickr:()=>ys});var k=X({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ys=X({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var $t={};U($t,{base64:()=>Es,base64pad:()=>vs,base64url:()=>zt,base64urlpad:()=>Cs});var Es=D({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),vs=D({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),zt=D({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Cs=D({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var kt={};U(kt,{base8:()=>Ds});var Ds=D({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Ft={};U(Ft,{identity:()=>Ss});var Ss=he({prefix:"\0",name:"identity",encode:r=>Ur(r),decode:r=>Nr(r)});var Xi=new TextEncoder,Ji=new TextDecoder;var jt={};U(jt,{identity:()=>Gs});var Ls=Fr,$r=128,As=127,Ps=~As,Os=Math.pow(2,31);function Fr(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Os;)e[t++]=r&255|$r,r/=128;for(;r&Ps;)e[t++]=r&255|$r,r>>>=7;return e[t]=r|0,Fr.bytes=t-n+1,e}var _s=Wt,Bs=128,kr=127;function Wt(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw Wt.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&kr)<<s:(i&kr)*Math.pow(2,s),s+=7}while(i>=Bs);return Wt.bytes=o-n,t}var Ns=Math.pow(2,7),Us=Math.pow(2,14),Rs=Math.pow(2,21),Ms=Math.pow(2,28),Vs=Math.pow(2,35),zs=Math.pow(2,42),$s=Math.pow(2,49),ks=Math.pow(2,56),Fs=Math.pow(2,63),Ws=function(r){return r<Ns?1:r<Us?2:r<Rs?3:r<Ms?4:r<Vs?5:r<zs?6:r<$s?7:r<ks?8:r<Fs?9:10},js={encode:Ls,decode:_s,encodingLength:Ws},qs=js,Se=qs;function Te(r,e=0){return[Se.decode(r,e),Se.decode.bytes]}function fe(r,e,t=0){return Se.encode(r,e,t),e}function de(r){return Se.encodingLength(r)}function me(r,e){let t=e.byteLength,n=de(r),s=n+de(t),o=new Uint8Array(s+t);return fe(r,o,0),fe(t,o,n),o.set(e,s),new pe(r,t,e,o)}function Wr(r){let e=z(r),[t,n]=Te(e),[s,o]=Te(e.subarray(n)),i=e.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new pe(t,s,i,e)}function jr(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Br(r.bytes,t.bytes)}}var pe=class{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};var qr=0,Hs="identity",Hr=z;function Qs(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return me(qr,Hr(r))}var Gs={code:qr,name:Hs,encode:Hr,digest:Qs};var Gt={};U(Gt,{sha256:()=>Js,sha512:()=>Ks});var Qt=oe(V("crypto"),1);var Xs=20;function Ht({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:s}){return new qt(r,e,t,n,s)}var qt=class{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,s,o){this.name=e,this.code=t,this.encode=n,this.minDigestLength=s??Xs,this.maxDigestLength=o}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){let n=this.encode(e);return n instanceof Uint8Array?Qr(n,this.code,t?.truncate):n.then(s=>Qr(s,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}};function Qr(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return me(e,r)}var Js=Ht({name:"sha2-256",code:18,encode:r=>z(Qt.default.createHash("sha256").update(r).digest())}),Ks=Ht({name:"sha2-512",code:19,encode:r=>z(Qt.default.createHash("sha512").update(r).digest())});function Xr(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return Zs(t,Xt(r),e??k.encoder);default:return eo(t,Xt(r),e??J.encoder)}}var Jr=new WeakMap;function Xt(r){let e=Jr.get(r);if(e==null){let t=new Map;return Jr.set(r,t),t}return e}var be=class r{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Le)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==to)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=me(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&jr(e.multihash,n.multihash)}toString(e){return Xr(this,e)}toJSON(){return{"/":Xr(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:o,bytes:i}=t;return new r(n,s,o,i??Kr(n,s,o.bytes))}else if(t[ro]===!0){let{version:n,multihash:s,code:o}=t,i=Wr(s);return r.create(n,o,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Le)throw new Error(`Version 0 CID must use dag-pb (code: ${Le}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=Kr(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Le,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=z(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=s.subarray(t.multihashSize-t.digestSize),i=new pe(t.multihashCode,t.digestSize,o,s);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[h,x]=Te(e.subarray(t));return t+=x,h},s=n(),o=Le;if(s===18?(s=0,t=0):o=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=t,a=n(),u=n(),f=t+u,d=f-i;return{version:s,codec:o,multihashCode:a,digestSize:u,multihashSize:d,size:f}}static parse(e,t){let[n,s]=Ys(e,t),o=r.decode(s);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Xt(o).set(n,e),o}};function Ys(r,e){switch(r[0]){case"Q":{let t=e??k;return[k.prefix,t.decode(`${k.prefix}${r}`)]}case k.prefix:{let t=e??k;return[k.prefix,t.decode(r)]}case J.prefix:{let t=e??J;return[J.prefix,t.decode(r)]}case De.prefix:{let t=e??De;return[De.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Zs(r,e,t){let{prefix:n}=t;if(n!==k.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return s}function eo(r,e,t){let{prefix:n}=t,s=e.get(n);if(s==null){let o=t.encode(r);return e.set(n,o),o}else return s}var Le=112,to=18;function Kr(r,e,t){let n=de(r),s=n+de(e),o=new Uint8Array(s+t.byteLength);return fe(r,o,0),fe(e,o,n),o.set(t,s),o}var ro=Symbol.for("@ipld/js-cid/CID");var Ae={...Ft,...Nt,...kt,..._t,...Bt,...Rt,...Mt,...Vt,...$t,...Ut},xa={...Gt,...jt};function Zr(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var Yr=Zr("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Jt=Zr("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=ue(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),no={utf8:Yr,"utf-8":Yr,hex:Ae.base16,latin1:Jt,ascii:Jt,binary:Jt,...Ae},He=no;function Pe(r,e="utf8"){let t=He[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return e==="utf8"||e==="utf-8"?Y(en.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}var tn=V("node:buffer");function Z(r,e="utf8"){let t=He[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return e==="utf8"||e==="utf-8"?tn.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var A=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},j=class extends Error{static name="ValidationError";name="ValidationError"},Qe=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},Ge=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};var R=V("node:net");function Yt(r){return e=>Z(e,r)}function Zt(r){return e=>Pe(e,r)}function ge(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function ee(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function rn(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=Pe(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=ee(n);return G([t,s],t.length+s.length)}function nn(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=J.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=ee(n);return G([t,s],t.length+s.length)}function er(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=Z(e,"base32"),s=ge(t);return`${n}:${s}`}var tr=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new A("Invalid byte value in IP address");e[n]=s}),e},sn=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let o=(0,R.isIPv4)(t[n]),i;o&&(i=tr(t[n]),t[n]=Z(i.subarray(0,2),"base16")),i!=null&&++n<8&&t.splice(n,0,Z(i.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let o=[n,1];for(n=9-t.length;n>0;n--)o.push("0");t.splice.apply(t,o)}let s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let o=parseInt(t[n],16);if(isNaN(o)||o<0||o>65535)throw new A("Invalid byte value in IP address");s[e++]=o>>8&255,s[e++]=o&255}return s},on=function(r){if(r.byteLength!==4)throw new A("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},an=function(r){if(r.byteLength!==16)throw new A("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let s=r[n],o=r[n+1],i=`${s.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`;e.push(i)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new A(`Invalid IPv6 address "${t}"`)}};function cn(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new A(`Invalid IPv6 address "${r}"`)}}var Kt=Object.values(Ae).map(r=>r.decoder),so=(function(){let r=Kt[0].or(Kt[1]);return Kt.slice(2).forEach(e=>r=r.or(e)),r})();function un(r){return so.decode(r)}function ln(r){return e=>r.encoder.encode(e)}function oo(r){if(parseInt(r).toString()!==r)throw new j("Value must be an integer")}function io(r){if(r<0)throw new j("Value must be a positive integer, or zero")}function ao(r){return e=>{if(e>r)throw new j(`Value must be smaller than or equal to ${r}`)}}function co(...r){return e=>{for(let t of r)t(e)}}var Oe=co(oo,io,ao(65535));var T=-1,rr=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new Ge(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){let t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},q=new rr,Do=[{code:4,name:"ip4",size:32,valueToBytes:tr,bytesToValue:on,validate:r=>{if(!(0,R.isIPv4)(r))throw new j(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:ee,bytesToValue:ge,validate:Oe},{code:273,name:"udp",size:16,valueToBytes:ee,bytesToValue:ge,validate:Oe},{code:33,name:"dccp",size:16,valueToBytes:ee,bytesToValue:ge,validate:Oe},{code:41,name:"ip6",size:128,valueToBytes:sn,bytesToValue:an,stringToValue:cn,validate:r=>{if(!(0,R.isIPv6)(r))throw new j(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:T},{code:43,name:"ipcidr",size:8,bytesToValue:Yt("base10"),valueToBytes:Zt("base10")},{code:53,name:"dns",size:T},{code:54,name:"dns4",size:T},{code:55,name:"dns6",size:T},{code:56,name:"dnsaddr",size:T},{code:132,name:"sctp",size:16,valueToBytes:ee,bytesToValue:ge,validate:Oe},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:T,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:T,bytesToValue:Yt("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?Zt("base58btc")(r):be.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:er,valueToBytes:rn},{code:445,name:"onion3",size:296,bytesToValue:er,valueToBytes:nn},{code:446,name:"garlic64",size:T},{code:447,name:"garlic32",size:T},{code:448,name:"tls"},{code:449,name:"sni",size:T},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:T,bytesToValue:ln(zt),valueToBytes:un},{code:480,name:"http"},{code:481,name:"http-path",size:T,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:T}];Do.forEach(r=>{q.addProtocol(r)});function hn(r){let e=[],t=0;for(;t<r.length;){let n=It(r,t),s=q.getProtocol(n),o=le(n),i=So(s,r,t+o),a=0;i>0&&s.size===T&&(a=le(i));let u=o+a+i,f={code:n,name:s.name,bytes:r.subarray(t,t+u)};if(i>0){let d=t+o+a,h=r.subarray(d,d+i);f.value=s.bytesToValue?.(h)??Z(h)}e.push(f),t+=u}return e}function fn(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let s=q.getProtocol(n.code),o=le(n.code),i,a=0,u=0;n.value!=null&&(i=s.valueToBytes?.(n.value)??Pe(n.value),a=i.byteLength,s.size===T&&(u=le(a)));let f=new Uint8Array(o+u+a),d=0;Tt(n.code,f,d),d+=o,i!=null&&(s.size===T&&(Tt(a,f,d),d+=u),f.set(i,d)),n.bytes=f}t.push(n.bytes),e+=n.bytes.byteLength}return G(t,e)}function dn(r){if(r.charAt(0)!=="/")throw new A('String multiaddr must start with "/"');let e=[],t="protocol",n="",s="";for(let o=1;o<r.length;o++){let i=r.charAt(o);i!=="/"&&(t==="protocol"?s+=r.charAt(o):n+=r.charAt(o));let a=o===r.length-1;if(i==="/"||a){let u=q.getProtocol(s);if(t==="protocol"){if(u.size==null||u.size===0){e.push({code:u.code,name:u.name}),n="",s="",t="protocol";continue}else if(a)throw new A(`Component ${s} was missing value`);t="value"}else if(t==="value"){let f={code:u.code,name:u.name};if(u.size!=null&&u.size!==0){if(n==="")throw new A(`Component ${s} was missing value`);f.value=u.stringToValue?.(n)??n}e.push(f),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new A("Incomplete multiaddr");return e}function pn(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=q.getProtocol(e.code);if(t==null)throw new A(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function So(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:It(e,t)}var To=Symbol.for("nodejs.util.inspect.custom"),mr=Symbol.for("@multiformats/multiaddr");function Io(r){if(r==null&&(r="/"),mn(r))return r.getComponents();if(r instanceof Uint8Array)return hn(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),dn(r);if(Array.isArray(r))return r;throw new A("Must be a string, Uint8Array, Component[], or another Multiaddr")}var rt=class r{[mr]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=Io(e),t.validate!==!1&&Lo(this)}get bytes(){return this.#r==null&&(this.#r=fn(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=pn(this.#e)),this.#t}toJSON(){return this.toString()}getComponents(){return[...this.#e.map(e=>({...e}))]}encapsulate(e){let t=new r(e);return new r([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Qe(`Address ${this.toString()} does not contain subaddress: ${t}`);return new r(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new r(this.#e.slice(0,t),{validate:!1})}equals(e){return je(this.bytes,e.bytes)}[To](){return`Multiaddr(${this.toString()})`}};function Lo(r){r.getComponents().forEach(e=>{let t=q.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function mn(r){return!!r?.[mr]}function ne(r){return new rt(r)}var y=r=>({match:e=>{let t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),c=(r,e)=>({match:t=>{let n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),bn=r=>({match:e=>r.match(e)===!1?e:!1}),p=r=>({match:e=>{let t=r.match(e);return t===!1?e:t}}),O=(...r)=>({match:e=>{let t;for(let n of r){let s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),g=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e}});function E(...r){function e(s){if(s==null)return!1;let o=s.getComponents();for(let i of r){let a=i.match(o);if(a===!1)return!1;o=a}return o}function t(s){return e(s)!==!1}function n(s){let o=e(s);return o===!1?!1:o.length===0}return{matchers:r,matches:t,exactMatch:n}}var Ao=c(421),mc=E(Ao),st=c(54),ot=c(55),it=c(56),gr=c(53),bc=E(st,p(c(421))),gc=E(ot,p(c(421))),wc=E(it,p(c(421))),xc=E(O(gr,it,st,ot),p(c(421))),gn=g(c(4),p(c(43))),wn=g(p(c(42)),c(41),p(c(43))),wr=O(gn,wn),se=O(wr,gr,st,ot,it),yc=E(O(wr,g(O(gr,it,st,ot),p(c(421))))),Ec=E(gn),vc=E(wn),Cc=E(wr),xr=g(se,c(6)),Be=g(se,c(273)),xn=E(g(xr,p(c(421)))),Dc=E(Be),yr=g(Be,y(460),p(c(421))),at=g(Be,y(461),p(c(421))),Po=O(yr,at),Sc=E(yr),Tc=E(at),br=O(se,xr,Be,yr,at),yn=O(g(br,y(477),p(c(421)))),Ic=E(yn),En=O(g(br,y(478),p(c(421))),g(br,y(448),p(c(449)),y(477),p(c(421)))),Lc=E(En),vn=g(Be,y(280),p(c(466)),p(c(466)),p(c(421))),Ac=E(vn),Cn=g(at,y(465),p(c(466)),p(c(466)),p(c(421))),Pc=E(Cn),nt=O(yn,En,g(xr,p(c(421))),g(Po,p(c(421))),g(se,p(c(421))),vn,Cn,c(421)),Oc=E(nt),Oo=g(p(nt),y(290),bn(y(281)),p(c(421))),_c=E(Oo),_o=O(g(nt,y(290),y(281),p(c(421))),g(nt,y(281),p(c(421))),g(y(281),p(c(421)))),Bc=E(_o),Bo=O(g(se,c(6),y(480),p(c(421))),g(se,y(480),p(c(421)))),Nc=E(Bo),No=g(se,O(g(c(6,"443"),y(480)),g(c(6),y(443)),g(c(6),y(448),y(480)),g(y(448),y(480)),y(448),y(443)),p(c(421))),Uc=E(No),Uo=O(g(c(777),p(c(421)))),Rc=E(Uo),Ro=O(g(c(400),p(c(421)))),ct=E(Ro);var ut=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}};var Rn=oe(V("node:net"),1);var Sn=Symbol.for("@achingbrain/uint8arraylist");function Dn(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function lt(r){return!!r?.[Sn]}var Ee=class r{bufs;length;[Sn]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(lt(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(lt(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=Dn(this.bufs,e);return t.buf[t.index]}set(e,t){let n=Dn(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(lt(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:s}=this._subList(e,t);return G(n,s)}subarray(e,t){let{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:G(n,s)}sublist(e,t){let{bufs:n,length:s}=this._subList(e,t),o=new r;return o.length=s,o.bufs=[...n],o}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],s=0;for(let o=0;o<this.bufs.length;o++){let i=this.bufs[o],a=s,u=a+i.byteLength;if(s=u,e>=u)continue;let f=e>=a&&e<u,d=t>a&&t<=u;if(f&&d){if(e===a&&t===u){n.push(i);break}let h=e-a;n.push(i.subarray(h,h+(t-e)));break}if(f){if(e===0){n.push(i);continue}n.push(i.subarray(e-a));continue}if(d){if(t===u){n.push(i);break}n.push(i.subarray(0,t-a));break}n.push(i)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!lt(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let o=256,i=new Int32Array(o);for(let h=0;h<o;h++)i[h]=-1;for(let h=0;h<s;h++)i[n[h]]=h;let a=i,u=this.byteLength-n.byteLength,f=n.byteLength-1,d;for(let h=t;h<=u;h+=d){d=0;for(let x=f;x>=0;x--){let l=this.get(h+x);if(n[x]!==l){d=Math.max(1,x-a[l]);break}}if(d===0)return h}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=ue(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let s=W(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let s=W(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let s=W(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=ue(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let s=W(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let s=W(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let s=W(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let s=W(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let s=W(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!je(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((s,o)=>s+o.byteLength,0)),n.length=t,n}};function ht(r){let e=r.getComponents(),t={},n=0;if(e[n]?.name==="ip6zone"&&(t.zone=`${e[n].value}`,n++),e[n].name==="ip4"||e[n].name==="ip6"||e[n].name==="dns"||e[n].name==="dns4"||e[n].name==="dns6"?(t.type=e[n].name,t.host=e[n].value,n++):e[n].name==="dnsaddr"&&(t.type=e[n].name,t.host=`_dnsaddr.${e[n].value}`,n++),(e[n]?.name==="tcp"||e[n]?.name==="udp")&&(t.protocol=e[n].name==="tcp"?"tcp":"udp",t.port=parseInt(`${e[n].value}`),n++),e[n]?.name==="ipcidr"&&(t.type==="ip4"?t.cidr=parseInt(`${e[n].value}`):t.type==="ip6"&&(t.cidr=`${e[n].value}`),n++),t.type==null||t.host==null)throw new B(`Multiaddr ${r} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return e[n]?.name==="tls"&&e[n+1]?.name==="sni"&&(t.sni=e[n+1].value,n+=2),t}function ft(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var dt=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},ve=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new dt(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new dt(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var Er=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Tn(r={}){return Mo(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Mo(r,e){e=e??{};let t=e.onEnd,n=new ve,s,o,i,a=ft(),u=async()=>{try{return n.isEmpty()?i?{done:!0}:await new Promise((m,S)=>{o=_=>{o=null,n.push(_);try{m(r(n))}catch(L){S(L)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=ft()})}},f=m=>o!=null?o(m):(n.push(m),s),d=m=>(n=new ve,o!=null?o({error:m}):(n.push({error:m}),s)),h=m=>{if(i)return s;if(e?.objectMode!==!0&&m?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return f({done:!1,value:m})},x=m=>i?s:(i=!0,m!=null?d(m):f({done:!0})),l=()=>(n=new ve,x(),{done:!0}),b=m=>(x(m),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:u,return:l,throw:b,push:h,end:x,get readableLength(){return n.size},onEmpty:async m=>{let S=m?.signal;if(S?.throwIfAborted(),n.isEmpty())return;let _,L;S!=null&&(_=new Promise((N,M)=>{L=()=>{M(new Er)},S.addEventListener("abort",L)}));try{await Promise.race([a.promise,_])}finally{L!=null&&S!=null&&S?.removeEventListener("abort",L)}}},t==null)return s;let v=s;return s={[Symbol.asyncIterator](){return this},next(){return v.next()},throw(m){return v.throw(m),t!=null&&(t(m),t=void 0),{done:!0}},return(){return v.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(m){return v.end(m),t!=null&&(t(m),t=void 0),s},get readableLength(){return v.readableLength},onEmpty:m=>v.onEmpty(m)},s}var vr=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Cr=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},In=r=>globalThis.DOMException===void 0?new Cr(r):new DOMException(r),Ln=r=>{let e=r.reason===void 0?In("This operation was aborted."):r.reason;return e instanceof Error?e:In(e)};function Dr(r,e){let{milliseconds:t,fallback:n,message:s,customTimers:o={setTimeout,clearTimeout}}=e,i,a,f=new Promise((d,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:l}=e;l.aborted&&h(Ln(l)),a=()=>{h(Ln(l))},l.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(d,h);return}let x=new vr;i=o.setTimeout.call(void 0,()=>{if(n){try{d(n())}catch(l){h(l)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?d():s instanceof Error?h(s):(x.message=s??`Promise timed out after ${t} milliseconds`,h(x))},t),(async()=>{try{d(await r)}catch(l){h(l)}})()}).finally(()=>{f.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return f.clear=()=>{o.clearTimeout.call(void 0,i),i=void 0},f}var Vo=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function zo(r,e,t){let n,s=new Promise((o,i)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),u=[],{addListener:f,removeListener:d}=Vo(r),h=async(...l)=>{let b=t.multiArgs?l:l[0];if(t.filter)try{if(!await t.filter(b))return}catch(v){n(),i(v);return}u.push(b),t.count===u.length&&(n(),o(u))},x=(...l)=>{n(),i(t.rejectionMultiArgs?l:l[0])};n=()=>{for(let l of a)d(l,h);for(let l of t.rejectionEvents)a.includes(l)||d(l,x)};for(let l of a)f(l,h);for(let l of t.rejectionEvents)a.includes(l)||f(l,x);t.signal&&t.signal.addEventListener("abort",()=>{x(t.signal.reason)},{once:!0}),t.resolveImmediately&&o(u)});if(s.cancel=n,typeof t.timeout=="number"){let o=Dr(s,{milliseconds:t.timeout});return o.cancel=()=>{n(),o.clear()},o}return s}function K(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=zo(r,e,t),s=n.then(o=>o[0]);return s.cancel=n.cancel,s}var pt=class extends Error{static name="StreamClosedError";name="StreamClosedError"};function $o(r){return r.reason}async function An(r,e,t){if(e==null)return r;let n=t?.translateError??$o;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((o,i)=>{s=()=>{i(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}var ko=Math.pow(2,20)*4,mt=class extends ce{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??ko,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new Ee,this.writeBuffer=new Ee,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);let t=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()};this.addEventListener("drain",t);let n=s=>{this.onDrainPromise?.reject(s.error??new pt)};this.addEventListener("close",n)}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return this.writableNeedsDrain!==!0?Promise.resolve():(this.onDrainPromise==null&&(this.onDrainPromise=Promise.withResolvers()),An(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;let e=Tn(),t=o=>{e.push(o.data)};this.addEventListener("message",t);let n=o=>{e.end(o.error)};this.addEventListener("close",n);let s=()=>{e.end()};this.addEventListener("remoteCloseWrite",s);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",s)}}isReadable(){return this.status==="open"}send(e){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new Q(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(t){this.log("failed to send reset to remote - %e",t)}this.dispatchEvent(new ke(e))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Q("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Q("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Q(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.append(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}unshift(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Q(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.prepend(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(e){if(e.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(e),this.dispatchReadBuffer()}}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");let e=new Me;this.dispatchEvent(new Fe(e))}onTransportClosed(e){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),e!=null?this.abort(e):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new ae))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0,t=this.writeBuffer.byteLength,n=0;for(;this.writeBuffer.byteLength>0;){let s=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(s===0){e=!1;break}let o=this.writeBuffer.sublist(0,s),i=new Ee(o);this.writeBuffer.consume(o.byteLength);let a=this.sendData(o);if(e=a.canSendMore,n+=a.sentBytes,a.sentBytes!==i.byteLength&&(i.consume(a.sentBytes),this.writeBuffer.prepend(i)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}let e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new $e(e))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new Ce(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new Ce(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}};var bt=class extends mt{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",t=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),t.error!=null?t.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):t.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await K(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await K(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}};var On=oe(V("node:os"),1);function Pn(r){return!!(r.startsWith("169.254.")||r.toLowerCase().startsWith("fe80"))}function Sr(r,e,t){let n=[r.type,t??r.host];if(r.protocol!=null){let s=e??r.port;s!=null&&n.push(r.protocol,s)}return r.type==="ip6"&&r.zone!=null&&n.unshift("ip6zone",r.zone),r.cidr!=null&&n.push("ipcidr",r.cidr),ne(`/${n.join("/")}`)}var Fo={4:"IPv4",6:"IPv6"};function Wo(r){return["0.0.0.0","::"].includes(r)}function jo(r){let e=[],t=On.default.networkInterfaces();for(let[,n]of Object.entries(t))if(n!=null)for(let s of n)Pn(s.address)||s.family===Fo[r]&&e.push(s.address);return e}function _n(r,e){if(r==null)return[];let t=ht(r);return(t.type==="ip4"||t.type==="ip6")&&Wo(t.host)?jo(t.type==="ip4"?4:6).map(n=>Sr(t,e,n)):[Sr(t,e)]}function Bn(r,e){if(typeof r!="string")throw new B(`invalid ip provided: ${r}`);if(typeof e=="string"&&(e=parseInt(e)),isNaN(e))throw new B(`invalid port provided: ${e}`);if((0,R.isIPv4)(r))return ne(`/ip4/${r}/tcp/${e}`);if((0,R.isIPv6)(r))return ne(`/ip6/${r}/tcp/${e}`);throw new B(`invalid ip:port for creating a multiaddr: ${r}:${e}`)}var Tr=class extends bt{socket;constructor(e){let t=e.remoteAddr;if(e.localAddr!=null&&ct.matches(e.localAddr))t=e.localAddr;else if(t==null){if(e.socket.remoteAddress==null||e.socket.remotePort==null)throw new B("Could not determine remote address or port");t=Bn(e.socket.remoteAddress,e.socket.remotePort)}super({...e,remoteAddr:t}),this.socket=e.socket,this.socket.on("data",n=>{this.onData(n)}),this.socket.on("error",n=>{this.log("tcp error",t,n),this.abort(n)}),this.socket.setTimeout(e.inactivityTimeout??120*1e3),this.socket.once("timeout",()=>{this.log("tcp timeout",t),this.abort(new ie)}),this.socket.once("end",()=>{this.log("tcp end",t),this.onTransportClosed()}),this.socket.once("close",n=>{if(this.log("tcp close",t),n){this.abort(new Error("TCP transmission error"));return}this.onTransportClosed()}),this.socket.on("drain",()=>{this.log("tcp drain"),this.safeDispatchEvent("drain")})}sendData(e){let t=0,n=!0;for(let s of e)if(t+=s.byteLength,n=this.socket.write(s),!n)break;return{sentBytes:t,canSendMore:n}}async sendClose(e){this.socket.destroyed||(this.socket.destroySoon(),await K(this.socket,"close",e))}sendReset(){this.socket.resetAndDestroy()}sendPause(){this.socket.pause()}sendResume(){this.socket.resume()}},gt=r=>new Tr(r);var Nn=oe(V("os"),1),Un=oe(V("path"),1);function wt(r,e={}){if(ct.exactMatch(r)){let o=r.getComponents().find(i=>i.code===400)?.value;if(o==null)throw new B(`Multiaddr ${r} was not a Unix address`);return Nn.default.platform()==="win32"?{path:Un.default.join("\\\\.\\pipe\\",o)}:{path:o}}let t=ht(r),n=t.host,s=t.port;return{host:n,port:s,ipv6Only:t.type==="ip6",...e}}var I;(function(r){r[r.INACTIVE=0]="INACTIVE",r[r.ACTIVE=1]="ACTIVE",r[r.PAUSED=2]="PAUSED"})(I||(I={}));var xt=class extends ce{context;server;sockets=new Set;status={code:I.INACTIVE};metrics;addr;log;shutdownController;constructor(e){if(super(),this.context=e,e.keepAlive=e.keepAlive??!0,e.noDelay=e.noDelay??!0,e.allowHalfOpen=e.allowHalfOpen??!1,this.shutdownController=new AbortController,We(1/0,this.shutdownController.signal),this.log=e.logger.forComponent("libp2p:tcp:listener"),this.addr="unknown",this.server=Rn.default.createServer(e,this.onSocket.bind(this)),e.maxConnections!==void 0&&(this.server.maxConnections=e.maxConnections),e.closeServerOnMaxConnections!=null&&e.closeServerOnMaxConnections.closeAbove<e.closeServerOnMaxConnections.listenBelow)throw new B("closeAbove must be >= listenBelow");e.metrics?.registerMetricGroup("libp2p_tcp_inbound_connections_total",{label:"address",help:"Current active connections in TCP listener",calculate:()=>({[this.addr]:this.sockets.size})}),this.metrics={status:e.metrics?.registerMetricGroup("libp2p_tcp_listener_status_info",{label:"address",help:"Current status of the TCP listener socket"}),errors:e.metrics?.registerMetricGroup("libp2p_tcp_listener_errors_total",{label:"address",help:"Total count of TCP listener errors by type"}),events:e.metrics?.registerMetricGroup("libp2p_tcp_listener_events_total",{label:"address",help:"Total count of TCP listener events by type"})},this.server.on("listening",()=>{let t=this.server.address();t==null?this.addr="unknown":typeof t=="string"?this.addr=t:this.addr=`${t.address}:${t.port}`,this.metrics.status?.update({[this.addr]:I.ACTIVE}),this.safeDispatchEvent("listening")}).on("error",t=>{this.metrics.errors?.increment({[`${this.addr} listen_error`]:!0}),this.safeDispatchEvent("error",{detail:t})}).on("close",()=>{this.metrics.status?.update({[this.addr]:this.status.code}),this.status.code!==I.PAUSED&&this.safeDispatchEvent("close")}).on("drop",()=>{this.metrics.events?.increment({[`${this.addr} drop`]:!0})})}onSocket(e){if(this.metrics.events?.increment({[`${this.addr} connection`]:!0}),this.status.code!==I.ACTIVE)throw e.destroy(),new Ve("Server is not listening yet");let t;try{t=gt({socket:e,inactivityTimeout:this.context.inactivityTimeout,metrics:this.metrics?.events,metricPrefix:`${this.addr} `,direction:"inbound",localAddr:this.status.listeningAddr,log:this.context.logger.forComponent("libp2p:tcp:connection")})}catch(n){this.log.error("inbound connection failed - %e",n),this.metrics.errors?.increment({[`${this.addr} inbound_to_connection`]:!0}),e.destroy();return}this.log("new inbound connection %s",t.remoteAddr),this.sockets.add(e),this.context.upgrader.upgradeInbound(t,{signal:this.shutdownController.signal}).then(()=>{this.log("inbound connection upgraded %s",t.remoteAddr),e.once("close",()=>{this.sockets.delete(e),this.context.closeServerOnMaxConnections!=null&&this.sockets.size<this.context.closeServerOnMaxConnections.listenBelow&&this.resume().catch(n=>{this.log.error("error attempting to listen server once connection count under limit - %e",n),this.context.closeServerOnMaxConnections?.onListenError?.(n)})}),this.context.closeServerOnMaxConnections!=null&&this.sockets.size>=this.context.closeServerOnMaxConnections.closeAbove&&(this.log("pausing incoming connections as limit is exceeded - %d/%d",this.sockets.size,this.context.closeServerOnMaxConnections.closeAbove),this.pause())}).catch(async n=>{this.log.error("inbound connection upgrade failed - %e",n),this.metrics.errors?.increment({[`${this.addr} inbound_upgrade`]:!0}),this.sockets.delete(e),t.abort(n)})}getAddrs(){if(this.status.code===I.INACTIVE)return[];let e=this.server.address();return e==null?[]:typeof e=="string"?[ne(`/unix/${encodeURIComponent(e)}`)]:_n(this.status.listeningAddr,e.port)}updateAnnounceAddrs(){}async listen(e){if(this.status.code===I.ACTIVE||this.status.code===I.PAUSED)throw new ze("server is already listening");try{this.status={code:I.ACTIVE,listeningAddr:e,netConfig:wt(e,this.context)},await this.resume()}catch(t){throw this.status={code:I.INACTIVE},t}}async close(e){let t=[];this.server.listening&&t.push(K(this.server,"close",e)),this.pause(!0),this.shutdownController.abort(),this.sockets.forEach(n=>{n.readable&&(t.push(K(n,"close",e)),n.destroy())}),await Promise.all(t)}async resume(){if(this.server.listening||this.status.code===I.INACTIVE)return;let e=this.status.netConfig;await new Promise((t,n)=>{this.server.once("error",n),this.server.listen(e,t)}),this.status={...this.status,code:I.ACTIVE},this.log("listening on %s",this.server.address())}pause(e=!1){if(!this.server.listening&&this.status.code===I.PAUSED&&e){this.status={code:I.INACTIVE};return}!this.server.listening||this.status.code!==I.ACTIVE||(this.log("%s server on %s",e?"closing":"pausing",this.server.address()),this.status=e?{code:I.INACTIVE}:{...this.status,code:I.PAUSED},this.server.close())}};var yt=class{opts;metrics;components;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:tcp"),this.opts=t,this.components=e,e.metrics!=null&&(this.metrics={events:e.metrics.registerCounterGroup("libp2p_tcp_dialer_events_total",{label:"event",help:"Total count of TCP dialer events by type"}),errors:e.metrics.registerCounterGroup("libp2p_tcp_dialer_errors_total",{label:"event",help:"Total count of TCP dialer events by type"})})}[Ar]=!0;[Symbol.toStringTag]="@libp2p/tcp";[Or]=["@libp2p/transport"];async dial(e,t){t.keepAlive=t.keepAlive??!0,t.noDelay=t.noDelay??!0,t.allowHalfOpen=t.allowHalfOpen??!1;let n=await this._connect(e,t),s;try{s=gt({socket:n,inactivityTimeout:this.opts.outboundSocketInactivityTimeout,metrics:this.metrics?.events,direction:"outbound",remoteAddr:e,log:this.log.newScope("connection")})}catch(o){throw this.metrics?.errors.increment({outbound_to_connection:!0}),n.destroy(o),o}try{return this.log("new outbound connection %s",s.remoteAddr),await t.upgrader.upgradeOutbound(s,t)}catch(o){throw this.metrics?.errors.increment({outbound_upgrade:!0}),this.log.error("error upgrading outbound connection - %e",o),s.abort(o),o}}async _connect(e,t){t.signal.throwIfAborted(),t.onProgress?.(new ut("tcp:open-connection"));let n;return new Promise((s,o)=>{let i=Date.now(),a=wt(e,{...this.opts.dialOpts??{},...t});this.log("dialing %a with opts %o",e,a),n=Mn.default.connect(a);let u=l=>{this.log.error("dial to %a errored - %e",e,l);let b=a.path??`${a.host??""}:${a.port}`;l.message=`connection error ${b}: ${l.message}`,this.metrics?.events.increment({error:!0}),x(l)},f=()=>{this.log("connection timeout %a",e),this.metrics?.events.increment({timeout:!0});let l=new ie(`Connection timeout after ${Date.now()-i}ms`);n.emit("error",l)},d=()=>{this.log("connection opened %a",e),this.metrics?.events.increment({connect:!0}),x()},h=()=>{this.log("connection aborted %a",e),this.metrics?.events.increment({abort:!0}),x(new Re)},x=l=>{if(n.removeListener("error",u),n.removeListener("timeout",f),n.removeListener("connect",d),t.signal!=null&&t.signal.removeEventListener("abort",h),l!=null){o(l);return}s(n)};n.on("error",u),n.on("timeout",f),n.on("connect",d),t.signal.addEventListener("abort",h)}).catch(s=>{throw n?.destroy(),s})}createListener(e){return new xt({...this.opts.listenOpts??{},...e,maxConnections:this.opts.maxConnections,backlog:this.opts.backlog,closeServerOnMaxConnections:this.opts.closeServerOnMaxConnections,inactivityTimeout:this.opts.inboundSocketInactivityTimeout,metrics:this.components.metrics,logger:this.components.logger})}listenFilter(e){return e.filter(t=>xn.exactMatch(t)||t.toString().startsWith("/unix/"))}dialFilter(e){return this.listenFilter(e)}};function qo(r={}){return e=>new yt(e,r)}return Wn(Ho);})();
return Libp2PTcp}));
//# sourceMappingURL=index.min.js.map
